name: Demo.Serverless.Hotels
concurrency: demo-serverless-hotels

on:
  push:
    branches:
      - main
      - feature/**

  workflow_dispatch:

env:
  PackagePath: "./published"
  FunctionAppName: "ccfunkyhotels"
  ResourceGroupName: "rg-cc-funky-hotels-dev"
  ResourceGroupLocation: "australiasoutheast"
  queues: hotel-cancellations

jobs:
  pipeline:
    name: CI/CD Pipeline
    runs-on: ubuntu-latest
    steps:
      - name: Provision Azure resources for a vanilla function app
        uses: Cheranga/GitHubActions/vanillafunctionapp@master
        with:
          credentials: ${{ secrets.AZURE_CREDENTIALS }}
          deploymentName: '${{ github.run_number }}-${{ env.FunctionAppName }}'
          environmentName: 'dev'
          resourceGroupName: ${{ env.ResourceGroupName }}
          functionAppName: ${{ env.FunctionAppName }}
          location: ${{ env.ResourceGroupLocation }}
          category: 'nonprod'
      
      - name: Create storage queue
        uses: Cheranga/GitHubActions/storageaccount@master          
        with:
          credentials: ${{secrets.AZURE_CREDENTIALS}}
          deploymentName: ${{ github.run_number }}-storage-account-updates
          resourceGroupName: ${{ env.ResourceGroupName }}
          name: sg${{ env.FunctionAppName }}dev
          location: ${{env.ResourceGroupLocation}}
          storageType: nonprod
          queues: ${{ env.queues }}
  
      - name: Provide function app to access queue based on RBAC
        uses: Cheranga/GitHubActions/assignrbactostorage@master
        with:
          deploymentName: ${{ github.run_number }}-assign-rbac
          resourceGroupName: ${{ env.ResourceGroupName }}
          credentials: ${{secrets.AZURE_CREDENTIALS}}
          storageAccountName: sg${{ env.FunctionAppName }}dev
          accessibility: queue_read_write
          friendlyName: ${{ env.FunctionAppName }}
          functionAppName: ${{ env.FunctionAppName }}dev
  
      - name: Update function app settings
        uses: Cheranga/GitHubActions/functionappsettings@master
        with:
          deploymentName: ${{ github.run_number }}-update-functionapp-settings
          resourceGroupName: ${{ env.ResourceGroupName }}
          location: ${{env.ResourceGroupLocation}}
          credentials: ${{secrets.AZURE_CREDENTIALS}}
          functionAppName: ${{ env.FunctionAppName }}dev
          appSettings: ${{ secrets.APP_SETTINGS }}

      - name: Deploy code to function app
        uses: Cheranga/GitHubActions/deploydotnetfunctionapp@master
        with:
          credentials: ${{secrets.AZURE_CREDENTIALS}}
          dotnetVersion: 6.0.x
          functionAppName: ${{ env.FunctionAppName }}dev