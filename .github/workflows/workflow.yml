name: Demo.Serverless.Hotels
concurrency: demo-serverless-hotels

on:
  push:
    branches:
      - main
      - feature/**

  workflow_dispatch: 

env:
  PackagePath: './published'


jobs:
  provision:
    name: 'Setup Azure Infrastructure'    
    runs-on: ubuntu-latest

    env:
      ResourceGroupName: 'rg-cc-gha-hotels-dev'
      ResourceGroupLocation: 'australiasoutheast'
      StorageAccountName: 'sgccdemohotelsdev'
      StorageSku: 'Standard_LRS'
      StorageSkuTier: 'Standard'
      FunctionAppName: 'demohotels'
      EnvironmentName: 'dev'
      AspName: 'plan-demohotels-dev'
      PlanSku: 'Y1'
      PlanTier: 'Dynamic'
      SharedResourceGroup: 'rg-cc-platform'
      SharedStorageAccount: 'sgccplatformdemo'

    steps:      
      - name: 'Create resource group'
        uses: Cheranga/GitHubActions/createresourcegroup@master
        with:
          credentials: ${{ secrets.AZURE_CREDENTIALS }}
          name: ${{env.ResourceGroupName}}
          location: ${{env.ResourceGroupLocation}}      
      - name: 'Create test key vault'
        uses: Cheranga/GitHubActions/keyvault@master
        with:
          credentials: ${{ secrets.AZURE_CREDENTIALS }}
          keyVaultName: 'kv-cc-blah'
          resourceGroupName: ${{ env.ResourceGroupName }}
          location: ${{ env.ResourceGroupLocation }}
          readAccessPrincipalList: '68e5356d-cc10-4024-b860-d718026182a1'          
  #     - name: 'Checkout repository'
  #       uses: actions/checkout@v2      
  #     - name: 'Provision Azure Resources'             
  #       uses: azure/arm-deploy@v1
  #       with:
  #         failOnStdErr: false
  #         deploymentName: ${{ github.run_number }}
  #         resourceGroupName: ${{ env.ResourceGroupName }}
  #         template: ./Deploy/Resources/main.bicep
  #         parameters: ./Deploy/Parameters/dev.json

  # buildanddeploy:
  #   needs: provision
  #   name: 'Build and Deploy'
  #   runs-on: ubuntu-latest
  #   env:
  #     FunctionAppName: 'fn-demohotels-dev'      
  #   steps:
  #     - name: 'Build and Deploy the Function App'
  #       uses: Cheranga/GitHubActions/buildanddeploytofunctionapp@master
  #       with:
  #         credentials: ${{secrets.AZURE_CREDENTIALS}}
  #         dotnetVersion: '6.0.x'
  #         functionAppName: ${{env.FunctionAppName}}           